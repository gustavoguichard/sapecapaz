/*
	Speed Plug-in
	
	Features:
		*Adds several properties to the 'file' object indicated upload speed, time left, upload time, etc.
			- currentSpeed -- String indicating the upload speed, bytes per second
			- averageSpeed -- Overall average upload speed, bytes per second
			- movingAverageSpeed -- Speed over averaged over the last several measurements, bytes per second
			- timeRemaining -- Estimated remaining upload time in seconds
			- timeElapsed -- Number of seconds passed for this upload
			- percentUploaded -- Percentage of the file uploaded (0 to 100)
			- sizeUploaded -- Formatted size uploaded so far, bytes
		
		*Adds setting 'moving_average_history_size' for defining the window size used to calculate the moving average speed.
		
		*Adds several Formatting functions for formatting that values provided on the file object.
			- SWFUpload.speed.formatBPS(bps) -- outputs string formatted in the best units (Gbps, Mbps, Kbps, bps)
			- SWFUpload.speed.formatTime(seconds) -- outputs string formatted in the best units (x Hr y M z S)
			- SWFUpload.speed.formatSize(bytes) -- outputs string formatted in the best units (w GB x MB y KB z B )
			- SWFUpload.speed.formatPercent(percent) -- outputs string formatted with a percent sign (x.xx %)
			- SWFUpload.speed.formatUnits(baseNumber, divisionArray, unitLabelArray, fractionalBoolean)
				- Formats a number using the division array to determine how to apply the labels in the Label Array
				- factionalBoolean indicates whether the number should be returned as a single fractional number with a unit (speed)
				    or as several numbers labeled with units (time)
	*/var SWFUpload;if(typeof SWFUpload=="function"){SWFUpload.speed={};SWFUpload.prototype.initSettings=function(e){return function(){typeof e=="function"&&e.call(this);this.ensureDefault=function(e,t){this.settings[e]=this.settings[e]==undefined?t:this.settings[e]};this.fileSpeedStats={};this.speedSettings={};this.ensureDefault("moving_average_history_size","10");this.speedSettings.user_file_queued_handler=this.settings.file_queued_handler;this.speedSettings.user_file_queue_error_handler=this.settings.file_queue_error_handler;this.speedSettings.user_upload_start_handler=this.settings.upload_start_handler;this.speedSettings.user_upload_error_handler=this.settings.upload_error_handler;this.speedSettings.user_upload_progress_handler=this.settings.upload_progress_handler;this.speedSettings.user_upload_success_handler=this.settings.upload_success_handler;this.speedSettings.user_upload_complete_handler=this.settings.upload_complete_handler;this.settings.file_queued_handler=SWFUpload.speed.fileQueuedHandler;this.settings.file_queue_error_handler=SWFUpload.speed.fileQueueErrorHandler;this.settings.upload_start_handler=SWFUpload.speed.uploadStartHandler;this.settings.upload_error_handler=SWFUpload.speed.uploadErrorHandler;this.settings.upload_progress_handler=SWFUpload.speed.uploadProgressHandler;this.settings.upload_success_handler=SWFUpload.speed.uploadSuccessHandler;this.settings.upload_complete_handler=SWFUpload.speed.uploadCompleteHandler;delete this.ensureDefault}}(SWFUpload.prototype.initSettings);SWFUpload.speed.fileQueuedHandler=function(e){if(typeof this.speedSettings.user_file_queued_handler=="function"){e=SWFUpload.speed.extendFile(e);return this.speedSettings.user_file_queued_handler.call(this,e)}};SWFUpload.speed.fileQueueErrorHandler=function(e,t,n){if(typeof this.speedSettings.user_file_queue_error_handler=="function"){e=SWFUpload.speed.extendFile(e);return this.speedSettings.user_file_queue_error_handler.call(this,e,t,n)}};SWFUpload.speed.uploadStartHandler=function(e){if(typeof this.speedSettings.user_upload_start_handler=="function"){e=SWFUpload.speed.extendFile(e,this.fileSpeedStats);return this.speedSettings.user_upload_start_handler.call(this,e)}};SWFUpload.speed.uploadErrorHandler=function(e,t,n){e=SWFUpload.speed.extendFile(e,this.fileSpeedStats);SWFUpload.speed.removeTracking(e,this.fileSpeedStats);if(typeof this.speedSettings.user_upload_error_handler=="function")return this.speedSettings.user_upload_error_handler.call(this,e,t,n)};SWFUpload.speed.uploadProgressHandler=function(e,t,n){this.updateTracking(e,t);e=SWFUpload.speed.extendFile(e,this.fileSpeedStats);if(typeof this.speedSettings.user_upload_progress_handler=="function")return this.speedSettings.user_upload_progress_handler.call(this,e,t,n)};SWFUpload.speed.uploadSuccessHandler=function(e,t){if(typeof this.speedSettings.user_upload_success_handler=="function"){e=SWFUpload.speed.extendFile(e,this.fileSpeedStats);return this.speedSettings.user_upload_success_handler.call(this,e,t)}};SWFUpload.speed.uploadCompleteHandler=function(e){e=SWFUpload.speed.extendFile(e,this.fileSpeedStats);SWFUpload.speed.removeTracking(e,this.fileSpeedStats);if(typeof this.speedSettings.user_upload_complete_handler=="function")return this.speedSettings.user_upload_complete_handler.call(this,e)};SWFUpload.speed.extendFile=function(e,t){var n;t&&(n=t[e.id]);if(n){e.currentSpeed=n.currentSpeed;e.averageSpeed=n.averageSpeed;e.movingAverageSpeed=n.movingAverageSpeed;e.timeRemaining=n.timeRemaining;e.timeElapsed=n.timeElapsed;e.percentUploaded=n.percentUploaded;e.sizeUploaded=n.bytesUploaded}else{e.currentSpeed=0;e.averageSpeed=0;e.movingAverageSpeed=0;e.timeRemaining=0;e.timeElapsed=0;e.percentUploaded=0;e.sizeUploaded=0}return e};SWFUpload.prototype.updateTracking=function(e,t){var n=this.fileSpeedStats[e.id];n||(this.fileSpeedStats[e.id]=n={});t=t||n.bytesUploaded||0;t<0&&(t=0);t>e.size&&(t=e.size);var r=(new Date).getTime();if(!n.startTime){n.startTime=(new Date).getTime();n.lastTime=n.startTime;n.currentSpeed=0;n.averageSpeed=0;n.movingAverageSpeed=0;n.movingAverageHistory=[];n.timeRemaining=0;n.timeElapsed=0;n.percentUploaded=t/e.size;n.bytesUploaded=t}else if(n.startTime>r)this.debug("When backwards in time");else{var i=(new Date).getTime(),s=n.lastTime,o=i-s,u=t-n.bytesUploaded;if(u===0||o===0)return n;n.lastTime=i;n.bytesUploaded=t;n.currentSpeed=u*8/(o/1e3);n.averageSpeed=n.bytesUploaded*8/((i-n.startTime)/1e3);n.movingAverageHistory.push(n.currentSpeed);n.movingAverageHistory.length>this.settings.moving_average_history_size&&n.movingAverageHistory.shift();n.movingAverageSpeed=SWFUpload.speed.calculateMovingAverage(n.movingAverageHistory);n.timeRemaining=(e.size-n.bytesUploaded)*8/n.movingAverageSpeed;n.timeElapsed=(i-n.startTime)/1e3;n.percentUploaded=n.bytesUploaded/e.size*100}return n};SWFUpload.speed.removeTracking=function(e,t){try{t[e.id]=null;delete t[e.id]}catch(n){}};SWFUpload.speed.formatUnits=function(e,t,n,r){var i,s,o,u;if(e===0)return"0 "+n[n.length-1];if(r){s=e;u=n.length>=t.length?n[t.length-1]:"";for(i=0;i<t.length;i++)if(e>=t[i]){s=(e/t[i]).toFixed(2);u=n.length>=i?" "+n[i]:"";break}return s+u}var a=[],f=e;for(i=0;i<t.length;i++){o=t[i];u=n.length>i?" "+n[i]:"";s=f/o;i<t.length-1?s=Math.floor(s):s=s.toFixed(2);if(s>0){f%=o;a.push(s+u)}}return a.join(" ")};SWFUpload.speed.formatBPS=function(e){var t=[1073741824,1048576,1024,1],n=["Gbps","Mbps","Kbps","bps"];return SWFUpload.speed.formatUnits(e,t,n,!0)};SWFUpload.speed.formatTime=function(e){var t=[86400,3600,60,1],n=["d","h","m","s"];return SWFUpload.speed.formatUnits(e,t,n,!1)};SWFUpload.speed.formatBytes=function(e){var t=[1073741824,1048576,1024,1],n=["GB","MB","KB","bytes"];return SWFUpload.speed.formatUnits(e,t,n,!0)};SWFUpload.speed.formatPercent=function(e){return e.toFixed(2)+" %"};SWFUpload.speed.calculateMovingAverage=function(e){var t=[],n,r=0,i=0,s=0,o=0,u=0,a,f=0,l=0;n=e.length;if(n>=8){for(a=0;a<n;a++){t[a]=e[a];r+=t[a]}i=r/n;for(a=0;a<n;a++)s+=Math.pow(t[a]-i,2);o=s/n;u=Math.sqrt(o);for(a=0;a<n;a++)t[a]=(t[a]-i)/u;var c=2;for(a=0;a<n;a++)if(t[a]<=c&&t[a]>=-c){l++;f+=e[a]}}else{l=n;for(a=0;a<n;a++)f+=e[a]}return f/l}};