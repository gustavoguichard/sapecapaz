(function(){tinymce.create("tinymce.plugins.wpGallery",{init:function(e,t){var n=this;n.url=t;n._createButtons();e.addCommand("WP_Gallery",function(){var t=e.selection.getNode(),n,r=tinymce.DOM.getViewPort(),i=r.h-80,s=640<r.w?640:r.w;if(t.nodeName!="IMG")return;if(e.dom.getAttrib(t,"class").indexOf("wpGallery")==-1)return;n=tinymce.DOM.get("post_ID").value;tb_show("",tinymce.documentBaseURL+"media-upload.php?post_id="+n+"&tab=gallery&TB_iframe=true&width="+s+"&height="+i);tinymce.DOM.setStyle(["TB_overlay","TB_window","TB_load"],"z-index","999999")});e.onMouseDown.add(function(e,t){t.target.nodeName=="IMG"&&e.dom.hasClass(t.target,"wpGallery")&&e.plugins.wordpress._showButtons(t.target,"wp_gallerybtns")});e.onBeforeSetContent.add(function(e,t){t.content=n._do_gallery(t.content)});e.onPostProcess.add(function(e,t){t.get&&(t.content=n._get_gallery(t.content))})},_do_gallery:function(e){return e.replace(/\[gallery([^\]]*)\]/g,function(e,t){return'<img src="'+tinymce.baseURL+'/plugins/wpgallery/img/t.gif" class="wpGallery mceItem" title="gallery'+tinymce.DOM.encode(t)+'" />'})},_get_gallery:function(e){function t(e,t){t=(new RegExp(t+'="([^"]+)"',"g")).exec(e);return t?tinymce.DOM.decode(t[1]):""}return e.replace(/(?:<p[^>]*>)*(<img[^>]+>)(?:<\/p>)*/g,function(e,n){var r=t(n,"class");return r.indexOf("wpGallery")!=-1?"<p>["+tinymce.trim(t(n,"title"))+"]</p>":e})},_createButtons:function(){var e=this,t=tinyMCE.activeEditor,n=tinymce.DOM,r,i;n.remove("wp_gallerybtns");n.add(document.body,"div",{id:"wp_gallerybtns",style:"display:none;"});r=n.add("wp_gallerybtns","img",{src:e.url+"/img/edit.png",id:"wp_editgallery",width:"24",height:"24",title:t.getLang("wordpress.editgallery")});tinymce.dom.Event.add(r,"mousedown",function(e){var t=tinyMCE.activeEditor;t.windowManager.bookmark=t.selection.getBookmark("simple");t.execCommand("WP_Gallery")});i=n.add("wp_gallerybtns","img",{src:e.url+"/img/delete.png",id:"wp_delgallery",width:"24",height:"24",title:t.getLang("wordpress.delgallery")});tinymce.dom.Event.add(i,"mousedown",function(e){var t=tinyMCE.activeEditor,n=t.selection.getNode();if(n.nodeName=="IMG"&&t.dom.hasClass(n,"wpGallery")){t.dom.remove(n);t.execCommand("mceRepaint");return!1}})},getInfo:function(){return{longname:"Gallery Settings",author:"WordPress",authorurl:"http://wordpress.org",infourl:"",version:"1.0"}}});tinymce.PluginManager.add("wpgallery",tinymce.plugins.wpGallery)})();