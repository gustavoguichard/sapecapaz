(function(e){e.Jcrop=function(t,n){function j(e){return""+parseInt(e)+"px"}function F(e){return""+parseInt(e)+"%"}function I(e){return s.baseClass+"-"+e}function q(t){var n=e(t).offset();return[n.left,n.top]}function R(e){return[e.pageX-k[0],e.pageY-k[1]]}function U(e){if(e!=A){H.setCursor(e);A=e}}function z(e,t){k=q(u);H.setCursor(e=="move"?e:e+"-resize");if(e=="move")return H.activateHandlers(X(t),Q);var n=D.getFixed(),r=V(e),i=D.getCorner(V(r));D.setPressed(D.getCorner(r));D.setCurrent(i);H.activateHandlers(W(e,n),Q)}function W(e,t){return function(n){if(!s.aspectRatio)switch(e){case"e":n[1]=t.y2;break;case"w":n[1]=t.y2;break;case"n":n[0]=t.x2;break;case"s":n[0]=t.x2}else switch(e){case"e":n[1]=t.y+1;break;case"w":n[1]=t.y+1;break;case"n":n[0]=t.x+1;break;case"s":n[0]=t.x+1}D.setCurrent(n);P.update()}}function X(e){var t=e;B.watchKeys();return function(e){D.moveOffset([e[0]-t[0],e[1]-t[1]]);t=e;P.update()}}function V(e){switch(e){case"n":return"sw";case"s":return"nw";case"e":return"nw";case"w":return"ne";case"ne":return"sw";case"nw":return"se";case"se":return"nw";case"sw":return"ne"}}function $(e){return function(t){if(s.disabled)return!1;if(e=="move"&&!s.allowMove)return!1;L=!0;z(e,R(t));t.stopPropagation();t.preventDefault();return!1}}function J(e,t,n){var r=e.width(),i=e.height();if(r>t&&t>0){r=t;i=t/e.width()*e.height()}if(i>n&&n>0){i=n;r=n/e.height()*e.width()}T=e.width()/r;N=e.height()/i;e.width(r).height(i)}function K(e){return{x:parseInt(e.x*T),y:parseInt(e.y*N),x2:parseInt(e.x2*T),y2:parseInt(e.y2*N),w:parseInt(e.w*T),h:parseInt(e.h*N)}}function Q(e){var t=D.getFixed();if(t.w>s.minSelect[0]&&t.h>s.minSelect[1]){P.enableHandles();P.done()}else P.release();H.setCursor(s.allowSelect?"crosshair":"default")}function G(e){if(s.disabled)return!1;if(!s.allowSelect)return!1;L=!0;k=q(u);P.disableHandles();U("crosshair");var t=R(e);D.setPressed(t);H.activateHandlers(Y,Q);B.watchKeys();P.update();e.stopPropagation();e.preventDefault();return!1}function Y(e){D.setCurrent(e);P.update()}function Z(){var t=e("<div></div>").addClass(I("tracker"));e.browser.msie&&t.css({opacity:0,backgroundColor:"white"});return t}function et(e){function b(){window.setTimeout(y,f)}var t=e[0]/T,n=e[1]/N,r=e[2]/T,i=e[3]/N;if(M)return;var o=D.flipCoords(t,n,r,i),u=D.getFixed(),a=initcr=[u.x,u.y,u.x2,u.y2],f=s.animationDelay,l=a[0],c=a[1],r=a[2],i=a[3],h=o[0]-initcr[0],p=o[1]-initcr[1],d=o[2]-initcr[2],v=o[3]-initcr[3],m=0,g=s.swingSpeed;P.animMode(!0);var y=function(){return function(){m+=(100-m)/g;a[0]=l+m/100*h;a[1]=c+m/100*p;a[2]=r+m/100*d;a[3]=i+m/100*v;m<100?b():P.done();m>=99.8&&(m=100);nt(a)}}();b()}function tt(e){nt([e[0]/T,e[1]/N,e[2]/T,e[3]/N])}function nt(e){D.setPressed([e[0],e[1]]);D.setCurrent([e[2],e[3]]);P.update()}function rt(t){typeof t!="object"&&(t={});s=e.extend(s,t);typeof s.onChange!="function"&&(s.onChange=function(){});typeof s.onSelect!="function"&&(s.onSelect=function(){})}function it(){return K(D.getFixed())}function st(){return D.getFixed()}function ot(e){rt(e);ct()}function ut(){s.disabled=!0;P.disableHandles();P.setCursor("default");H.setCursor("default")}function at(){s.disabled=!1;ct()}function ft(){P.done();H.activateHandlers(null,null)}function lt(){c.remove();o.show()}function ct(e){s.allowResize?e?P.enableOnly():P.enableHandles():P.disableHandles();H.setCursor(s.allowSelect?"crosshair":"default");P.setCursor(s.allowMove?"move":"default");c.css("backgroundColor",s.bgColor);if("setSelect"in s){tt(n.setSelect);P.done();delete s.setSelect}if("trueSize"in s){T=s.trueSize[0]/f;N=s.trueSize[1]/l}b=s.maxSize[0]||0;E=s.maxSize[1]||0;S=s.minSize[0]||0;x=s.minSize[1]||0;if("outerImage"in s){u.attr("src",s.outerImage);delete s.outerImage}P.refresh()}var t=t,n=n;typeof t!="object"&&(t=e(t)[0]);typeof n!="object"&&(n={});if(!("trackDocument"in n)){n.trackDocument=e.browser.msie?!1:!0;e.browser.msie&&e.browser.version.split(".")[0]=="8"&&(n.trackDocument=!0)}"keySupport"in n||(n.keySupport=e.browser.msie?!1:!0);var r={trackDocument:!1,baseClass:"jcrop",addClass:null,bgColor:"black",bgOpacity:.6,borderOpacity:.4,handleOpacity:.5,handlePad:5,handleSize:9,handleOffset:5,edgeMargin:14,aspectRatio:0,keySupport:!0,cornerHandles:!0,sideHandles:!0,drawBorders:!0,dragEdges:!0,boxWidth:0,boxHeight:0,boundary:8,animationDelay:20,swingSpeed:3,allowSelect:!0,allowMove:!0,allowResize:!0,minSelect:[0,0],maxSize:[0,0],minSize:[0,0],onChange:function(){},onSelect:function(){}},s=r;rt(n);var o=e(t),u=o.clone().removeAttr("id").css({position:"absolute"});u.width(o.width());u.height(o.height());o.after(u).hide();J(u,s.boxWidth,s.boxHeight);var f=u.width(),l=u.height(),c=e("<div />").width(f).height(l).addClass(I("holder")).css({position:"relative",backgroundColor:s.bgColor}).insertAfter(o).append(u);s.addClass&&c.addClass(s.addClass);var p=e("<img />").attr("src",u.attr("src")).css("position","absolute").width(f).height(l),d=e("<div />").width(F(100)).height(F(100)).css({zIndex:310,position:"absolute",overflow:"hidden"}).append(p),v=e("<div />").width(F(100)).height(F(100)).css("zIndex",320),m=e("<div />").css({position:"absolute",zIndex:300}).insertBefore(u).append(d,v),g=s.boundary,y=Z().width(f+g*2).height(l+g*2).css({position:"absolute",top:j(-g),left:j(-g),zIndex:290}).mousedown(G),b,E,S,x,T,N,C=!0,k=q(u),L,A,O,M,_,D=function(){function u(i){var i=m(i);n=e=i[0];r=t=i[1]}function a(e){var e=m(e);i=e[0]-n;o=e[1]-r;n=e[0];r=e[1]}function c(){return[i,o]}function p(i){var s=i[0],o=i[1];0>e+s&&(s-=s+e);0>t+o&&(o-=o+t);l<r+o&&(o+=l-(r+o));f<n+s&&(s+=f-(n+s));e+=s;n+=s;t+=o;r+=o}function d(e){var t=v();switch(e){case"ne":return[t.x2,t.y];case"nw":return[t.x,t.y];case"se":return[t.x2,t.y2];case"sw":return[t.x,t.y2]}}function v(){if(!s.aspectRatio)return y();var i=s.aspectRatio,o=s.minSize[0]/T,u=s.minSize[1]/N,a=s.maxSize[0]/T,c=s.maxSize[1]/N,p=n-e,d=r-t,v=Math.abs(p),m=Math.abs(d),b=v/m,E,S;a==0&&(a=f*10);c==0&&(c=l*10);if(b<i){S=r;w=m*i;E=p<0?e-w:w+e;if(E<0){E=0;h=Math.abs((E-e)/i);S=d<0?t-h:h+t}else if(E>f){E=f;h=Math.abs((E-e)/i);S=d<0?t-h:h+t}}else{E=n;h=v/i;S=d<0?t-h:t+h;if(S<0){S=0;w=Math.abs((S-t)*i);E=p<0?e-w:w+e}else if(S>l){S=l;w=Math.abs(S-t)*i;E=p<0?e-w:w+e}}if(E>e){E-e<o?E=e+o:E-e>a&&(E=e+a);S>t?S=t+(E-e)/i:S=t-(E-e)/i}else if(E<e){e-E<o?E=e-o:e-E>a&&(E=e-a);S>t?S=t+(e-E)/i:S=t-(e-E)/i}if(E<0){e-=E;E=0}else if(E>f){e-=E-f;E=f}if(S<0){t-=S;S=0}else if(S>l){t-=S-l;S=l}return last=C(g(e,t,E,S))}function m(e){e[0]<0&&(e[0]=0);e[1]<0&&(e[1]=0);e[0]>f&&(e[0]=f);e[1]>l&&(e[1]=l);return[e[0],e[1]]}function g(e,t,n,r){var i=e,s=n,o=t,u=r;if(n<e){i=n;s=e}if(r<t){o=r;u=t}return[Math.round(i),Math.round(o),Math.round(s),Math.round(u)]}function y(){var i=n-e,s=r-t;b&&Math.abs(i)>b&&(n=i>0?e+b:e-b);E&&Math.abs(s)>E&&(r=s>0?t+E:t-E);x&&Math.abs(s)<x&&(r=s>0?t+x:t-x);S&&Math.abs(i)<S&&(n=i>0?e+S:e-S);if(e<0){n-=e;e-=e}if(t<0){r-=t;t-=t}if(n<0){e-=n;n-=n}if(r<0){t-=r;r-=r}if(n>f){var o=n-f;e-=o;n-=o}if(r>l){var o=r-l;t-=o;r-=o}if(e>f){var o=e-l;r-=o;t-=o}if(t>l){var o=t-l;r-=o;t-=o}return C(g(e,t,n,r))}function C(e){return{x:e[0],y:e[1],x2:e[2],y2:e[3],w:e[2]-e[0],h:e[3]-e[1]}}var e=0,t=0,n=0,r=0,i,o;return{flipCoords:g,setPressed:u,setCurrent:a,getOffset:c,moveOffset:p,getCorner:d,getFixed:v}}(),P=function(){function y(t){var n=e("<div />").css({position:"absolute",opacity:s.borderOpacity}).addClass(I(t));d.append(n);return n}function b(t,n){var r=e("<div />").mousedown($(t)).css({cursor:t+"-resize",position:"absolute",zIndex:n});v.append(r);return r}function w(e){return b(e,f++).css({top:j(-g+1),left:j(-g+1),opacity:s.handleOpacity}).addClass(I("handle"))}function E(e){var t=s.handleSize,n=g,r=t,i=t,o=n,u=n;switch(e){case"n":case"s":i=F(100);break;case"e":case"w":r=F(100)}return b(e,f++).width(i).height(r).css({top:j(-o+1),left:j(-u+1)})}function S(e){for(i in e)c[e[i]]=w(e[i])}function x(e){var t=Math.round(e.h/2-g),n=Math.round(e.w/2-g),r=west=-g+1,i=e.w-g,s=e.h-g,o,u;"e"in c&&c.e.css({top:j(t),left:j(i)})&&c.w.css({top:j(t)})&&c.s.css({top:j(s),left:j(n)})&&c.n.css({left:j(n)});"ne"in c&&c.ne.css({left:j(i)})&&c.se.css({top:j(s),left:j(i)})&&c.sw.css({top:j(s)});"b"in c&&c.b.css({top:j(s)})&&c.r.css({left:j(i)})}function T(e,t){p.css({top:j(-t),left:j(-e)});m.css({top:j(t),left:j(e)})}function N(e,t){m.width(e).height(t)}function C(){var e=D.getFixed();D.setPressed([e.x,e.y]);D.setCurrent([e.x2,e.y2]);k()}function k(){if(o)return L()}function L(){var e=D.getFixed();N(e.w,e.h);T(e.x,e.y);s.drawBorders&&l.right.css({left:j(e.w-1)})&&l.bottom.css({top:j(e.h-1)});h&&x(e);o||A();s.onChange(K(e))}function A(){m.show();u.css("opacity",s.bgOpacity);o=!0}function O(){H();m.hide();u.css("opacity",1);o=!1}function _(){if(h){x(D.getFixed());v.show()}}function P(){h=!0;if(s.allowResize){x(D.getFixed());v.show();return!0}}function H(){h=!1;v.hide()}function B(e){(M=e)?H():P()}function q(){B(!1);C()}var t,n,r,o,f=370,l={},c={},h=!1,g=s.handleOffset;s.drawBorders&&(l={top:y("hline").css("top",e.browser.msie?j(-1):j(0)),bottom:y("hline"),left:y("vline"),right:y("vline")});if(s.dragEdges){c.t=E("n");c.b=E("s");c.r=E("e");c.l=E("w")}s.sideHandles&&S(["n","s","e","w"]);s.cornerHandles&&S(["sw","nw","ne","se"]);var R=Z().mousedown($("move")).css({cursor:"move",position:"absolute",zIndex:360});d.append(R);H();return{updateVisible:k,update:L,release:O,refresh:C,setCursor:function(e){R.css("cursor",e)},enableHandles:P,enableOnly:function(){h=!0},showHandles:_,disableHandles:H,animMode:B,done:q}}(),H=function(){function i(){y.css({zIndex:450});r&&e(document).mousemove(f).mouseup(l)}function o(){y.css({zIndex:290});r&&e(document).unbind("mousemove",f).unbind("mouseup",l)}function f(e){t(R(e))}function l(e){e.preventDefault();e.stopPropagation();if(L){L=!1;n(R(e));s.onSelect(K(D.getFixed()));o();t=function(){};n=function(){}}return!1}function c(e,r){L=!0;t=e;n=r;i();return!1}function h(e){y.css("cursor",e)}var t=function(){},n=function(){},r=s.trackDocument;r||y.mousemove(f).mouseup(l).mouseout(l);u.before(y);return{activateHandlers:c,setCursor:h}}(),B=function(){function r(){if(s.keySupport){t.show();t.focus()}}function i(e){t.hide()}function o(e,t,n){if(s.allowMove){D.moveOffset([t,n]);P.updateVisible()}e.preventDefault();e.stopPropagation()}function f(e){if(e.ctrlKey)return!0;_=e.shiftKey?!0:!1;var t=_?10:1;switch(e.keyCode){case 37:o(e,-t,0);break;case 39:o(e,t,0);break;case 38:o(e,0,-t);break;case 40:o(e,0,t);break;case 27:P.release();break;case 9:return!0}return nothing(e)}var t=e('<input type="radio" />').css({position:"absolute",left:"-30px"}).keypress(f).blur(i),n=e("<div />").css({position:"absolute",overflow:"hidden"}).append(t);s.keySupport&&n.insertBefore(u);return{watchKeys:r}}();v.hide();ct(!0);var ht={animateTo:et,setSelect:tt,setOptions:ot,tellSelect:it,tellScaled:st,disable:ut,enable:at,cancel:ft,focus:B.watchKeys,getBounds:function(){return[f*T,l*N]},getWidgetSize:function(){return[f,l]},release:P.release,destroy:lt};o.data("Jcrop",ht);return ht};e.fn.Jcrop=function(t){function n(n){var r=t.useImg||n.src,i=new Image;i.onload=function(){e.Jcrop(n,t)};i.src=r}typeof t!="object"&&(t={});this.each(function(){if(e(this).data("Jcrop")){if(t=="api")return e(this).data("Jcrop");e(this).data("Jcrop").setOptions(t)}else n(this)});return this}})(jQuery);